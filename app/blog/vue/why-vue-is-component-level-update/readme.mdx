# ä¸ºä»€ä¹ˆvueæ˜¯ç»„ä»¶çº§åˆ«çš„æ›´æ–°

<div className='tips-wrapper rounded bg-[#e9eaff] p-2'>
  <div className='font-semibold text-black'>tips</div>
  <div className='flex items-center'>
    ğŸš¨
    <span className='ml-1 text-xs text-red-500'>
      è¿™ç¯‡ç¬”è®°æ˜¯å…³äº Vue 2.7 çš„ç»„ä»¶æµç¨‹çš„ï¼Œ[å¦‚æœä½ æƒ³äº†è§£ Vue 3
      çš„ç»„ä»¶æµç¨‹ï¼Œè¯·å‚è€ƒå¦ä¸€ç¯‡ç¬”è®°ã€‚](/blog/vue/vue3-mounting-and-updating-components)
    </span>
  </div>
</div>

é¦–å…ˆåœ¨reactä¸­ï¼Œå¦‚æœä¸€ä¸ªçˆ¶ç»„ä»¶æ›´æ–°äº†ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ˆæ²¡æœ‰åšmemoä¹‹ç±»çš„æ€§èƒ½ä¼˜åŒ–ï¼‰å…¶åŒ…å«çš„æ‰€æœ‰å­ç»„ä»¶éƒ½ä¼šæ›´æ–°ï¼Œæ— è®ºè¿™äº›å­ç»„ä»¶æ˜¯å¦ä¾èµ–äº†çˆ¶ç»„ä»¶çš„çŠ¶æ€ï¼Œ
æ­¤å¤–ï¼Œ[ä¹Ÿä¸æ˜¯ä» setState çš„ç»„ä»¶å¼€å§‹æ›´æ–°ï¼Œè€Œæ˜¯è¦ä» `root` å¼€å§‹éå†è¿›è¡Œdiff](https://segmentfault.com/q/1010000041065111)ï¼Œä¸ä¸€å®šè‡ªé¡¶å‘ä¸‹çš„æ›´æ–°é‚£äº›ç»„ä»¶ï¼Œä½†ä¼šè¿›è¡Œdiffã€‚
ä½†åœ¨vueä¸­ä»…ä»…åªä¼šæ›´æ–°çˆ¶ç»„ä»¶ï¼Œåªä¼šåœ¨æœ‰éœ€è¦çš„æƒ…å†µä¸‹ï¼Œå­ç»„ä»¶æ‰ä¼šæ›´æ–°ï¼Œæ¯”å¦‚ä¾èµ–äº†çˆ¶ç»„ä»¶çš„çŠ¶æ€ï¼Œä¸”çˆ¶ç»„ä»¶çš„çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–

## 1ã€æ¯”å¦‚è¿™ä¹ˆä¸€ä¸ªç»„ä»¶

```html filename="index.html"
<div id="app">
  <test :msg="message.text"></test>
  <linzhe></linzhe>
</div>
<script type="module">
  import Vue, { reactive, h, ref } from './vue.esm.js'
  const vm = new Vue({
    components: {
      test: {
        props: ['msg'],
        updated() {
          // ä¼šè§¦å‘
          console.log('test update')
        },
        template: `<div>{{msg}}</div>`,
      },
      linzhe: {
        template: `<div>linzhe141</div>`,
        updated() {
          // ä¸ä¼šè§¦å‘
          console.log('linzhe update')
        },
      },
    },
    data() {
      return {
        message: { text: 'Hello World!' },
      }
    },
    updated() {
      // ä¼šè§¦å‘
      console.log('app update')
    },
  })
  vm.$mount('#app')
  window.vm = vm
  setTimeout(() => {
    vm.message.text = 'ssssssssssss'
    console.log('update')
  }, 2000)
</script>
```

## 2ã€initProps

åœ¨`initProps`ä¸­ä¼šæŠŠå­ç»„ä»¶ä¸­çš„`_props`å˜æˆå“åº”å¼å¯¹è±¡ï¼Œä»è€Œè¿›è¡Œä¾èµ–æ”¶é›†

```js
function initProps$1(vm, propsOptions) {
  ...
  // propsData => :msg="message" => {msg: {text:Hello World!}}ï¼Œè¿™ä¸ªmsgå¯¹è±¡æ˜¯çˆ¶ç»„ä»¶ä¼ é€’è¿‡æ¥çš„å“åº”å¼æ•°æ®
  const propsData = vm.$options.propsData || {}
  const props = (vm._props = shallowReactive({}))
  const keys = (vm.$options._propKeys = [])
  const isRoot = !vm.$parent
  for (const key in propsOptions) {
    keys.push(key)
    // è¿™ä¸ªvalueå°±æ˜¯ç”¨æˆ·ä¼ é€’çš„props.msgï¼Œ
    // ä¸¾ä¾‹ï¼šå¦‚æœæ˜¯ä¸€ä¸ªå“åº”å¼æ•°æ®ï¼Œé‚£ä¹ˆä¹Ÿè¿˜æ˜¯ä¸€ä¸ªå“åº”å¼æ•°æ®
    const value = validateProp(key, propsOptions, propsData, vm)
    // å°†ç¬¦åˆçš„propsçš„keyå®šä¹‰æˆå“åº”å¼ï¼Œæ‰€ä»¥å­ç»„ä»¶å°±ä¼šå¯¹è¿™äº›propsè¿›è¡Œä¾èµ–æ”¶é›†
    // å½“çˆ¶ç»„ä»¶è¿›è¡ŒupdateChildComponentä¿®æ”¹äº†props[key]ï¼Œå¯¹åº”çš„å­ç»„ä»¶æ‰ä¼šè¿›è¡Œæ›´æ–°ï¼Œå¦åˆ™ä¸ä¼šæ›´æ–°

    //! è¿™è¡Œä»£ç æ˜¯é‡ç‚¹ï¼Œå¹¶ä¸”è¿™ä¸ªæµç¨‹å’Œvue3ä¸ä¸€æ ·
    defineReactive(props, key, value, () => {
      // é˜²æ­¢ç”¨æˆ·åœ¨å­ç»„ä»¶ä¸­æ‰‹åŠ¨ä¿®æ”¹propsçš„å€¼ï¼Œå› ä¸ºè¦ä¿è¯å•å‘æ•°æ®æµ
      if (!isRoot && !isUpdatingChildComponent) {
        warn$2(
          `Avoid mutating a prop directly since the value will be ` +
            `overwritten whenever the parent component re-renders. ` +
            `Instead, use a data or computed property based on the prop's ` +
            `value. Prop being mutated: "${key}"`,
          vm
        )
      }
    })
  }
}
```

## 3ã€å˜æ›´æµç¨‹

- åœ¨vueä¸­ä¸€ä¸ªç»„ä»¶åœ¨æŒ‚è½½æ—¶ï¼Œä¼šä½¿ç”¨watcherè¿›è¡Œä¾èµ–æ”¶é›†ï¼Œæ‰€ä»¥å½“5såè¿™ä¸ª`updateComponent`å°±ä¼šé‡æ–°æ‰§è¡Œ

  ```js
  // æŒ‚è½½
  function mountComponent(vm, el, hydrating) {
    ...
    updateComponent = () => {
      // DIFF
      vm._update(vm._render(), hydrating)
    }
    ...
    new Watcher(
      vm,
      updateComponent,
      noop,
      watcherOptions,
      true /* isRenderWatcher */
    )
  }

  ```

- åœ¨è¿›è¡ŒDIFFæ—¶ï¼Œå½“vnodeæ˜¯ç»„ä»¶ï¼Œå°±ä¼šè¿›è¡Œ`updateChildComponent`ï¼Œåœ¨updateChildComponentä¸­å°±ä¼šæ›´æ–°æœ€æ–°ä¼ é€’çš„propsï¼Œ**è€Œä¸ä¼šæ·±å…¥åˆ°ç»„ä»¶å†…éƒ¨è¿›è¡Œæ›´æ–°ã€‚**
  ç”±äº`initProps`å‡½æ•°ï¼Œæ‰€ä»¥å­ç»„ä»¶çš„`_props`å˜æˆäº†å“åº”å¼æ•°æ®äº†ï¼Œå¹¶ä¸”å“åº”å¼æ•°æ®åˆå˜æ›´äº†ï¼Œé‚£ä¹ˆè‡ªç„¶ä¼šé‡æ–°è¿›è¡Œå­ç»„ä»¶çš„`updateComponent`ï¼Œ
  ä»è€Œè¿›è¡Œé‡æ–°æ¸²æŸ“äº†ï¼Œè€Œåƒé‚£ç§æ²¡æœ‰ä¾èµ–çˆ¶ç»„ä»¶çŠ¶æ€çš„`linzhe`ç»„ä»¶ï¼Œå› ä¸º`_props`æ²¡æœ‰å˜åŒ–ï¼Œå°±ä¸ä¼šé‡æ–°æ¸²æŸ“äº†ï¼Œæ‰€ä»¥ç»¼ä¸Šæ¥è¯´`vueå°±æ˜¯ç»„ä»¶çº§åˆ«çš„æ›´æ–°`

  ```js
  // 1 DIFF
  function patchVnode( oldVnode, vnode, ...) {
    ...
    // ç»„ä»¶çš„vnode
    // componentVNodeHooks
    // { data: {hook: {..., prepatch, ...}} }
    let i;
    const data = vnode.data;
    if (isDef(data) && isDef((i = data.hook)) && isDef((i = i.prepatch))) {
      i(oldVnode, vnode) // prepatch(oldVnode, vnode)
    }
  }
  prepatch(oldVnode, vnode) {
    ...
    updateChildComponent(
      child,
      options.propsData, // updated props
      options.listeners, // updated  listeners
      vnode, // new parent vnode
      options.children // new children
    );
  }
  // 2 æ›´æ–°å­ç»„ä»¶
  function updateChildComponent(...){
    ...
    isUpdatingChildComponent = true //åªæœ‰åœ¨æ›´æ–°å­ç»„ä»¶æ—¶ï¼Œæ‰èƒ½å»æ”¹propsï¼Œå¦åˆ™éƒ½ä¼šæŠ¥é”™ï¼Œä¿è¯å•é€‰æ•°æ®æµ
    // update props
    // vm è¿™é‡Œçš„vmæ˜¯å­ç»„ä»¶å®ä¾‹

    // è¿™é‡Œå°±æ˜¯è§£é‡Šäº†ä¸ºä»€ä¹ˆvueæ˜¯ç»„ä»¶çº§åˆ«çš„æ›´æ–°äº†
    // å°±æ¯”å¦‚linzheè¿™ä¸ªç»„ä»¶ï¼Œç”±äºå®ƒæ²¡æœ‰å¯¹åº”çš„propsï¼Œ
    // é‚£ä¹ˆpropsDataæ˜¯undefinedï¼Œæ‰€ä»¥propsè¿™ä¸ªå“åº”å¼æ•°æ®å°±ä¸ä¼šæ›´æ–°ï¼Œ
    // å¯¹åº”çš„æ¸²æŸ“watcherä¹Ÿä¸ä¼šé‡æ–°æ‰§è¡Œï¼Œæ‰€ä»¥å­ç»„ä»¶å°±ä¸ä¼šæ›´æ–°
    if (propsData && vm.$options.props) {
      const props = vm._props;
      const propKeys = vm.$options._propKeys || [];
      for (let i = 0; i < propKeys.length; i++) {
        const key = propKeys[i];
        const propOptions = vm.$options.props; // wtf flow?
        props[key] = validateProp(key, propOptions, propsData, vm);
        // è¿™é‡Œå°±ä¼šè§¦å‘å¯¹åº”çš„å­ç»„ä»¶é‡æ–°æ›´æ–°äº†ï¼ŒåŠå…¶ä¾èµ–propså‰¯ä½œç”¨å‡½æ•°ä¹Ÿä¼šæ›´æ–°ï¼Œæ¯”å¦‚computed
      }
    }
    isUpdatingChildComponent = false
    ...
  }
  ```
